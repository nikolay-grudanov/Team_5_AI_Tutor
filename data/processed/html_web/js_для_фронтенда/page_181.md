---
source_image: page_181.png
page_number: 181
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 34.57
tokens: 6380
characters: 2009
timestamp: 2025-12-24T10:06:27.389875
finish_reason: stop
---

В вышеприведенном коде клиентский JavaScript говорит HTTP-серверу, чтобы тот сгенерировал файлы покрытия на основании параметра строки запроса. Теперь нам надо добавить дополнительный параметр к строке запроса (вызова) require, который будет сигнализировать серверному коду, надо или не надо возвращать файл покрытия для вызываемого файла.

Обратите внимание, что все это требует двух проходов: первый проход определяет, для каких файлов нужно сгенерировать файлы покрытия, а второй проход выполняет тесты, динамически перехватывает вызовы require и возвращает файлы покрытия для запрошенных файлов. Это происходит потому, что код yuitest_coverage требует порождения внешнего асинхронного процесса для создания файлов покрытия, а вызов require — синхронный. В этом нет ничего страшного, но об этом вы должны знать. Если Node.js даже освободит синхронный метод или если полностью синхронный генератор покрытия станет доступным, файлы покрытия могут быть сгенерированы в переопределенном методе load.

Итак, как же добавить дополнительный параметр в request для запроса покрытого кода? Для начала, ваш тестовый код может выглядеть как-то так:

my moduleToTest = require('./src/testMe', true);

Данный оператор внутри тестового сценария в случае вызова внешнего модуля добавляет второй параметр (true) к вызову require. Node.js проигнорирует этот неожиданный параметр, а мы его перехватим с помощью следующего регулярного выражения:

/require\s*\(\s*["'"]([^\'"']+)["'"]\s*,\s*true\s*\)/g

Все это выглядит сложнее, чем есть на самом деле. А на самом деле все очень просто: идея заключается в том, чтобы загрузить ваш JavaScript-файл, а потом с помощью этого регулярного выражения перехватить все вызовы модулей с дополнительным параметром true. Можно использовать и другие способы (JavaScript-парсер, построить абстрактное синтаксическое дерево с помощью JSLint или Uglify.js, может быть что-то еще), но на практике приведенное регулярное выражение является самым адекватным и на 100% оправдало свое применение.
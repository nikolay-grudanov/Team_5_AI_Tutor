---
source_image: page_255.png
page_number: 255
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 35.81
tokens: 7599
characters: 2437
timestamp: 2025-12-24T03:07:44.210312
finish_reason: stop
---

Вызов setattr устанавливает атрибут пропатченного вызываемого объекта (в данном случае check_output). Патч состоит из лямбда-функции, возвращающей одну интересную строку. Поскольку функция subprocess.check_output нам напрямую неподвластна, а функция get_part_entry_type не позволяет внедрять значения каким-то другим способом, единственный вариант — патчинг.

Мы предпочитаем пробовать другие методики, например внедрение значений (известное под названием «внедрение зависимостей» (dependency injection)), прежде чем использовать патч, но иногда другого выхода нет. Удобство pytest во многом и состоит в том, что она может выполнять патчинг при тестировании, а потом освобождать все ресурсы.

Инфраструктурное тестирование

В этом разделе мы расскажем о тестировании и проверке инфраструктуры с помощью проекта Testinfra (https://oreil.ly/e7Afx) — плагина pytest для инфраструктуры, активно использующего фикстуры, с помощью которого можно писать тесты Python аналогично тестированию кода.

В предыдущих разделах приводились некоторые подробности использования и примеры pytest, а этот раздел начнем с понятия верификации на системном уровне. Мы расскажем о тестировании инфраструктуры в контексте ответа на вопрос: «Как выяснить, было ли развертывание успешным?» В большинстве случаев для ответа на него требуются производимые вручную проверки, например загрузка веб-сайта или просмотр списка процессов, но этого недостаточно и это чревато ошибками, к тому же может оказаться весьма утомительным при значительных размерах системы.

И хотя с pytest обычно знакомятся как со средством для написания и выполнения модульных тестов Python, имеет смысл перепрофилировать его для тестирования инфраструктуры. Несколько лет назад Альфредо дали задание создать программу установки, возможности которой были бы доступны через HTTP API. Она была предназначена для создания кластера Ceph (https://ceph.com), включающего довольно большое количество машин. В ходе контроля качества введения этого API в эксплуатацию Альфредо нередко получал отчеты о том, что кластер работает не так, как нужно, так что ему приходилось использовать учетные данные для входа на эти машины и их тщательного изучения. При отладке распределенной системы из нескольких машин возникал мультипликативный эффект: несколько файлов конфигурации, различные жесткие диски, сетевые настройки, причем различаться могло все что угодно, даже если на первый взгляд все было идентично.
---
source_image: page_376.png
page_number: 376
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 24.30
tokens: 7521
characters: 2117
timestamp: 2025-12-24T04:43:06.943546
finish_reason: stop
---

В качестве службы Web-сервера, который может обрабатывать только GET-запросы¹, будет выступать сценарий на языке командного интерпретатора (см. листинг 10.9). Он считывает три лексемы протокольного запроса ①, проверяет наличие запрошенного файла, имя которого было передано во второй лексеме (uri) ②, и возвращает его содержимое ③, предваряя двумя протокольными заголовками о типе ④ и размере ⑤ файла. Сценарий предполагает, что запросы протокола поступают на стандартный поток ввода, а ответы отправляются на стандартный поток вывода, и ни с какими сетевыми сокетами работать не умеет. Всю работу по открытию и обслуживанию сетевых сокетов, а также запуску сценария, возьмет на себя systemd.

Для вручения systemd новых юнитов работы необходимо разместить конфигурационные файлы определенного содержания (systemd.socket(5) и systemd.service(5)) в предопределенных каталогах. В листинге 10.10 показано, как можно попросить об этом команду systemctl(1), указав, что нужно изменять «пользовательскую» --user конфигурацию.

Листинг 10.10. Служба Web-сервера на основе systemd: юнит-файлы

morty@ubuntu:~$ EDITOR=nano systemctl --user edit --full peerweb.socket --force
[Socket]
① ListenStream=0.0.0.0:8080
② Accept=yes
morty@ubuntu:~$ EDITOR=nano systemctl --user edit --full peerweb@.service --force
[Service]
① ExecStart=/home/morty/bin/peerweb /home/morty/Public
① StandardInput=socket

Сокет-юнит peerweb.socket заставит systemd слушать ① потоковый (TCP) сетевой сокет на порту 8080 и принимать подключения ②, после чего они будут переданы одноименной «шаблонной» службе peerweb@.service, которая и будет обслуживать каждое подключение. Для этого служба должна запускать ③ сценарий ~/bin/peerweb и передавать ему в качестве параметра путь к каталогу ~/Public² и сокет принято подключения в качестве стандартных потоков ④ ввода-вывода. В результате HTTP-запрос будет отправлен на stdin сценария, а его stdout будет возвращен в сетевой сокет в качестве HTTP-ответа.

¹ https://www.youtube.com/watch?v=6ziuDdudUkl.
² Который по соглашению и так используется для публикации файлов, например, настольным окружением GNOME.
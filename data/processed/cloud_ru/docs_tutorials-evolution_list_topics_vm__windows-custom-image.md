---
source_image: docs_tutorials-evolution_list_topics_vm__windows-custom-image.jpg
page_number: 0
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 173.22
tokens: 10713
characters: 7072
timestamp: 2025-12-24T06:42:17.608142
finish_reason: stop
---

### Подготовка и создание пользовательского образа с ОС Windows

Эта статья полезна?

С помощью этого руководства вы подготовите файл образа виртуальной машины с операционной системой Windows, создадите пользовательский образ из этого файла и развернете виртуальную машину.

Вы развернете и настроите виртуальную машину с ОС Windows на локальном компьютере, а затем импортируете ее загрузочный диск в сервис «Образы». Для виртуализации на локальном компьютере с установленной ОС Ubuntu используется гипервизор KVM.

Вы будете использовать следующие сервисы:

• Образы — сервис для управления образами, из которых развертываются виртуальные машины.
• Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина, которая будет развернута из созданного образа.

Шаги:

1. Разверните виртуальную машину на локальном компьютере.
2. Установите Windows.
3. Загрузите образ в облако.
4. Разверните в облаке ВМ из созданного образа.

Перед началом работы

1. Зарегистрируйтесь в личном кабинете Cloud.ru.
   Если вы уже зарегистрированы, войдите под своей учетной записью.
2. Скачайте ISO-образ с операционной системой Windows. В руководстве используется ОС Windows Server 2019.
3. Скачайте подписанный ISO-образ с драйверами VirtIO.

1. Разверните виртуальную машину на локальном компьютере

На этом шаге вы развернете ВМ, которая будет использоваться для установки и настройки Windows. Виртуальная машина разворачивается на локальном компьютере с установленной ОС Ubuntu 22.04 и графическим интерфейсом.

1. Обновите пакеты. В терминале выполните команду:

   ```
   sudo apt update
   ```

2. Установите утилиты для виртуализации и использования графического интерфейса:

   ```
   sudo apt install virtinst virt-manager virt-viewer qemu-system-x86 qemu-utils
   ```

3. Создайте загрузочный диск для виртуальной машины размером 25 ГБ:

   ```
   qemu-img create -f raw windows-cloud.raw 25G
   ```

4. Назначьте системному пользователю libvirt-qemu права на каталог, в котором находится загрузочный диск и необходимые ISO-образы. libvirt-qemu — это системный пользователь, от имени которого работают процессы виртуализации.

   ```
   sudo setfacl -m u:libvirt-qemu:x <path_to_iso>
   ```

   Где <path_to_iso> — каталог, в котором находится загрузочный диск и необходимые ISO-образы.

5. Создайте виртуальную машину с помощью команды:

   ```
   virt-install \
     --connect qemu:///system \
     --name ws2019 \
     --ram 2048 \
     --vcpus 2 \
     --network network=default,model=virtio \
     --file /path/to/windows-cloud.raw,format=raw,device=disk,bus=virtio \
     --cdrom <path_to_win_iso> \
     --disk path=<path_to_virtio_iso>,device=cdrom \
     --vnc \
     --noautoconsole \
     --noreboot
   ```

   Где:
   • <path_to_win_iso> — путь к ISO-образу с операционной системой Windows.
   • <path_to_virtio_iso> — путь к ISO-образу с драйверами VirtIO.

2. Установите Windows

На этом шаге вы установите и настроите ОС Windows на развернутой ранее виртуальной машине. Далее образ загрузочного диска этой машины будет использоваться для развертывания виртуальных машин в облаке.

1. Подключитесь к созданной ВМ.

   ```
   virt-viewer ws2019
   ```

   Откроется программа установки Windows.

2. На стартовом экране в поле Time and currency format выберите Russian (Russia) и нажмите Next.

3. Нажмите Install Now.

4. Выберите тип инсталляции Custom.

5. По умолчанию программа установки не обнаружит локальные диски без загрузки драйверов. Загрузите нужные драйверы вручную.
   a. Нажмите Load driver и выберите драйверы VirtIO SCSI в директории E:\virtio-win-0.1.xxx\viostor\2k19\amd64 . После установки драйверов в списке появится загрузочный диск.
   b. Нажмите Load driver и выберите сетевые драйверы в директории E:\virtio-win-0.1.xxx\NetKVM\2k19\amd64 .

6. Выберите появившийся диск на 25 ГБ и нажмите Next. Начнется процесс установки Windows, после завершения которого ВМ перезагрузится.

7. Запустите ВМ ws2019 :

   ```
   virsh start ws2019
   ```

8. Снова подключитесь к ВМ ws2019 через virt-viewer и установите пароль администратора.

9. Завершите установку драйверов:
   a. Перейдите в каталог E:\virtio-win-0.1.xxx .
   b. Запустите установочный файл virtio-win-gt-x64.msi и пройдите все шаги мастера установки.
   c. Перейдите в каталог E:\virtio-win-0.1.xxx\viostor\2k19\amd64 .
   d. Нажмите на файл viostor.inf правой кнопкой мыши и выберите Install.

10. Настройте Cloudbase-Init.
    a. Откройте PowerShell.
    b. Разрешите Cloudbase-Init запускать скрипты во время загрузки ВМ. Выполните команду:

       ```
       Set-ExecutionPolicy Unrestricted
       ```

    c. Загрузите Cloudbase-Init:

       ```
       Invoke-WebRequest -UseBasicParsing https://cloudbase.it/downloads/CloudbaseInitSetup_64bit_x64.msi
       ```

    d. Запустите установку Cloudbase-Init:

       ```
       .\cloudbaseinit.msi
       ```

    e. На шаге Configuration options:
       a. Укажите параметры:
          • Username: Administrator.
          • Serial port for logging: COM1.
       b. Включите опцию Run Cloudbase-Init service as LocalSystem.
       c. Нажмите Finish.

    f. Откройте файл C:\Program Files\Cloudbase Solutions\Cloudbase-Init\conf\cloudbase-init.conf .

    g. Добавьте строки и сохраните файл:

       ```
       metadata_services=cloudbaseinit.metadata.services.configdrive.ConfigDriveService,cloudbaseinit.metadata.plugins=cloudbaseinit.plugins.common,authhostname.SetHostNamePlugin,cloudbaseinit.plugins.windows.crs,stop_service_on_exit=false
       first_logon_behavior=no
       ```

11. Выполните генерализацию образа. В Powershell введите команду:

   ```
   C:\Windows\System32\sysprep\sysprep.exe /oobe /generalize /shutdown
   ```

3. Загрузите образ в облако

Создайте пользовательский образ в облаке Evolution, используя образ загрузочного диска виртуальной машины с установленной ОС Windows:

• Зона доступности — ru.AZ-1 .
• vCPU, шт — 2.
• RAM, ГБ — 2.
• Диск, ГБ — 30.
• Название — windows-server-2019 .
• Источник — выберите файл образа windows-cloud.raw .

4. Разверните в облаке ВМ из созданного образа

На этом шаге вы развернете в облаке Cloud.ru виртуальную машину с ОС Windows из пользовательского образа и подключитесь к ней.

1. Создайте виртуальную машину со следующими параметрами:
   • Название — win-server .
   • Зона доступности — ru.AZ-1 .
   • Образ — на вкладке Пользовательские выберите образ windows-server-2019 .
   • Гарантированная доля vCPU — 10%.
   • vCPU, шт — 2.
   • RAM, ГБ — 4.
   • Загрузочный диск — укажите размер 30 ГБ.
   • Сетевой интерфейс — выберите тип Подсеть с публичным IP .

2. Подключитесь к созданной ВМ.
   a. Выберите ВМ win-server в списке.
   b. Перейдите на вкладку Виртуальная консоль.
      Дождитесь загрузки системы.
   c. Выполните первоначальную настройку системы: укажите настройки языка и примите лицензионное соглашение.
   d. Установите пароль для пользователя Administrator и войдите в систему.

Результат

Вы научились подготавливать образы с ОС Windows, загружать их в облако Cloud.ru и разворачивать из них виртуальные машины.
---
source_image: docs_tutorials-evolution_list_topics_vm__smarthome.jpg
page_number: 0
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 294.38
tokens: 16841
characters: 10182
timestamp: 2025-12-24T06:40:12.900803
finish_reason: stop
---

<h2>Развертывание системы умного дома с использованием Node-RED и Mosquitto</h2>
<p>С помощью этого руководства вы научитесь основам IoT-автоматизации и выполните проект по управлению температурой в умном доме.</p>
<p>Вы создадите виртуальную машину Ubuntu 22.04, разработаете и развернете на ней систему умного дома, которая будет управлять кондиционером в зависимости от температуры в помещении.</p>
<p>Вы будете использовать скрипты в качестве эмуляторов умных устройств, но полученные навыки можно применять и при работе с физическими устройствами.</p>
<p>Для взаимодействия со скриптами используется MQTT-брюкер Mosquitto и программа Node-RED. После того как эмулятор датчика публикует данные в определенный топик, центр управления или другие умные устройства получают MQTT-сообщения. Node-RED подписывается на MQTT-сообщения, обрабатывает данные и запускает действия умных устройств.</p>
<p>В этом практическом руководстве эмулятор датчика выводит показатели температуры, Node-RED обрабатывает данные и включает или выключает кондиционер.</p>
<p>Вы будете использовать следующие сервисы:</p>
<ul>
<li>Виртуальные машины — сервис, в рамках которого предоставляется виртуальная машина для размещения приложения.</li>
<li>Публичный IP-адрес для доступа к сервису через интернет.</li>
<li>Node-RED — программа для визуального проектирования автоматизаций.</li>
<li>Mosquitto — брокер MQTT для обмена сообщениями между умными устройствами.</li>
</ul>
<p>Шаги:</p>
<ol>
<li>Разверните ресурсы в облаке.</li>
<li>Настройте окружение виртуальной машины.</li>
<li>Настройте основные компоненты умного дома.</li>
<li>Визуализируйте работу компонентов умного дома.</li>
<li>Протестируйте сценарий.</li>
</ol>
<h3>Перед началом работы</h3>
<ol>
<li>Зарегистрируйтесь в личном кабинете Cloud.ru.<br>Если вы уже зарегистрированы, войдите под своей учетной записью.</li>
<li>Сгенерируйте ключевую пару и загрузите публичный ключ в Cloud.ru Evolution.</li>
</ol>
<h3>1. Разверните ресурсы в облаке</h3>
<p>На этом шаге вы подготовите сеть, группу безопасности, виртуальную машину.</p>
<ol>
<li>Создайте виртуальную сеть с названием vpc-home.</li>
<li>Создайте подсеть со следующими параметрами:
<ul>
<li>Название — subnet-home.</li>
<li>VPC — vpc-home.</li>
<li>Адрес — 10.10.1.0/24.</li>
<li>DNS-серверы — 8.8.8.8.</li>
</ul>
</li>
<li>Создайте группу безопасности с названием sg-home и добавьте в нее правила:</li>
<table>
<tr><th>Трафик</th><th>Протокол</th><th>Порт</th><th>Тип источника/адресата</th><th>Источник/Адресат</th></tr>
<tr><td>Входящий</td><td>TCP</td><td>1883</td><td>IP-адрес</td><td>0.0.0.0/0</td></tr>
<tr><td>Входящий</td><td>TCP</td><td>1880</td><td>IP-адрес</td><td>0.0.0.0/0</td></tr>
<tr><td>Входящий</td><td>TCP</td><td>22</td><td>IP-адрес</td><td>0.0.0.0/0</td></tr>
<tr><td>Исходящий</td><td>TCP</td><td>1883</td><td>IP-адрес</td><td>0.0.0.0/0</td></tr>
<tr><td>Исходящий</td><td>Любой</td><td>Любой</td><td>IP-адрес</td><td>0.0.0.0/0</td></tr>
</table>
<li>Создайте виртуальную машину со следующими параметрами:
<ul>
<li>Название — vm-home.</li>
<li>Образ — публичный образ Ubuntu 22.04.</li>
<li>Сетевой интерфейс — выберите тип Подсеть с публичным IP.</li>
<li>VPC — vpc-home.</li>
<li>Подсеть — subnet-home.</li>
<li>Публичный IP — оставьте Арендовать новый или выберите IP-адрес из списка арендованных.</li>
<li>Группы безопасности — добавьте sg-home.</li>
<li>Метод аутентификации — выберите Публичный ключ.</li>
<li>Публичный ключ — укажите ключ, созданный ранее.</li>
<li>Остальные параметры оставьте по умолчанию или выберите на свое усмотрение.</li>
</ul>
</li>
</ol>
<p>Убедитесь, что ресурсы созданы и отображаются в личном кабинете:</p>
<ol>
<li>На странице Сети → VPC отображается сеть vpc-home, а в списке ее подсетей — subnet-home.</li>
<li>На странице Сети → Группы безопасности отображается группа безопасности sg-home со статусом «Создана».</li>
<li>На странице Инфраструктура → Виртуальные машины отображается виртуальная машина vm-home со статусом «Запущена».</li>
</ol>
<h3>2. Настройте окружение виртуальной машины</h3>
<p>На этом шаге вы установите необходимые пакеты и подготовите среду системы умного дома.</p>
<ol>
<li>Подключитесь к виртуальной машине по SSH.</li>
<li>Обновите систему и установите утилиты:</li>
<pre>sudo apt update &amp;&amp; sudo apt upgrade -y</pre>
<li>Установите пакетный менеджер pip и обновите его до последней версии:</li>
<pre>sudo apt install -y python3-pip &amp;&amp; python3 -m pip install --upgrade pip</pre>
<li>Установите Node.js и npm:</li>
<pre>curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs build-essential</pre>
<li>Установите Node-RED:</li>
<pre>sudo npm install -g --unsafe-perm node-red</pre>
<li>Настройте автоматический запуск Node-RED:</li>
<pre>sudo pm2 install -g pm2
pm2 start @which node-red) --name nodered
pm2 save &amp;&amp; pm2 startup</pre>
<li>Установите Mosquitto:</li>
<pre>sudo apt install -y mosquitto mosquitto-clients
sudo systemctl enable mosquitto</pre>
<li>Установите Python-библиотеку paho-mqtt для работы с MQTT-протоколом с разрешением на модификацию системных пакетов:</li>
<pre>pip3 install paho-mqtt --break-system-packages</pre>
</ol>
<h3>3. Настройте основные компоненты умного дома</h3>
<p>На этом шаге вы добавите компоненты умного дома — скрипты-эмуляторы датчика температуры и кондиционера.</p>
<ol>
<li>Создайте директорию проекта и перейдите в нее:</li>
<pre>mkdir smart_home &amp;&amp; cd smart_home</pre>
<li>Создайте файл temp_sensor.py :</li>
<pre>nano temp_sensor.py</pre>
<li>Добавьте в файл скрипт-эмулятор датчика температуры, который каждые 5 секунд генерирует случайный показатель температуры в диапазоне 18–35 °C.</li>
<pre>
import time
import random
import paho.mqtt.client as mqtt

broker = "localhost"
topic = "/home/room1/temp"

client = mqtt.Client()
client.connect(broker, 1883, 60)

while True:
    temp = round(random.uniform(18.0, 35.0), 1)
    print(f"[Sensor] Current temperature: {temp} °C")
    client.publish(topic, temp)
    time.sleep(5)
</pre>
<p>Где:</p>
<ul>
<li>broker = "localhost" — указывает брокер. Значение localhost используется, если Mosquitto установлен на той же машине, на которой запускается эмулятор.</li>
<li>topic = "/home/room1/temp" — указывает MQTT-топик, в который публикуется сгенерированный показатель.</li>
</ul>
<li>Создайте файл ac_emulator.py :</li>
<pre>nano ac_emulator.py</pre>
<li>Добывте в файл скрипт-эмулятор кондиционера, который подключается к Mosquitto и подписывается на MQTT-топик /home/room1/ac. При получении сообщения скрипт выводит информацию о том, включен кондиционер или нет.</li>
<pre>
import paho.mqtt.client as mqtt

topic = "/home/room1/ac"

def on_connect(client, userdata, flags, rc):
    print(f"[AC] Connected with result code {rc}")
    client.subscribe(topic)

def on_message(client, userdata, msg):
    command = msg.payload.decode()
    print(f"[AC] Received command: {command}")
    if command.upper() == "ON":
        print("[AC] Air conditioner turned ON")
    elif command.upper() == "OFF":
        print("[AC] Air conditioner turned OFF")
    else:
        print("[AC] Unknown command")

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

client.connect("localhost", 1883, 60)
client.loop_forever()
</pre>
</ol>
<h3>4. Визуализируйте работу компонентов умного дома</h3>
<p>На этом шаге вы настроите узлы блок-схемы в Node-RED, чтобы создать сценарии работы умного дома.</p>
<ol>
<li>На компьютере откройте браузер и перейдите по адресу http://<ip_address>:1880/, где <ip_address> — публичный IP-адрес виртуальной машины.<br>Откроется веб-интерфейс Node-RED.</li>
<li>Перетащите в рабочую область следующие узлы:
<ul>
<li>mqtt in</li>
<li>function</li>
<li>mqtt out</li>
</ul>
</li>
<li>Настройте узел mqtt in:
<ul>
<li>В рабочей области дважды нажмите на первый элемент mqtt.</li>
<li>В открывшемся окне справа от поля Сервер нажмите *.</li>
<li>Укажите параметры:
<ul>
<li>Имя — my_server.</li>
<li>Адрес — localhost.</li>
<li>Порт — 1883.</li>
</ul>
</li>
<li>Нажмите Добавить.</li>
<li>Укажите остальные параметры узла:
<ul>
<li>Тема — /home/room1/temp.</li>
<li>Quality of Service (QoS) — 0.</li>
<li>Имя — Температура.</li>
</ul>
</li>
<li>Нажмите Готово.</li>
</ul>
</li>
<li>Настройте узел function, чтобы он сравнивал температуру с пороговыми значениями и отправлял кондиционеру команду ON или OFF.
<ul>
<li>В рабочей области дважды нажмите на элемент function.</li>
<li>В поле Имя введите значение Порог температуры.</li>
<li>На вкладке Функция в поле ввода вставьте код:</li>
<pre>
let temp = parseFloat(mq.payload);
if (temp > 26) {
    mq.payload = "ON";
} else {
    mq.payload = "OFF";
}
return mq;
</pre>
</ul>
</li>
<li>Настройте узел mqtt out.
<ul>
<li>Дважды нажмите на второй элемент mqtt.</li>
<li>Укажите следующие значения параметров:
<ul>
<li>Сервер — my_server;</li>
<li>Тема — /home/room1/ac;</li>
<li>Имя — Кондиционер.</li>
</ul>
</li>
<li>Нажмите Готово.</li>
</ul>
</li>
<li>Соедините узлы.</li>
</ol>
<p><img src="https://example.com/node-red.png" alt="Node-RED блок-схема"></p>
<h3>5. Протестируйте сценарий</h3>
<p>На этом шаге вы запустите скрипты-эмуляторы умных устройств, чтобы протестировать сценарий.</p>
<ol>
<li>Откройте два окна терминала. В обоих окнах подключитесь по SSH к виртуальной машине vm-home.</li>
<li>В одном терминале запустите эмулятор датчика температуры:</li>
<pre>python3 temp_sensor.py</pre>
<li>Во втором терминале запустите эмулятор кондиционера:</li>
<pre>python3 ac_emulator.py</pre>
<li>На странице Node-RED http://<ip_address>:1880/ нажмите Развернуть.</li>
<li>Откройте терминал с запущенным эмулятором кондиционера.</li>
</ol>
<p>В терминале будет отображаться информация о включении и выключении кондиционера в зависимости от полученной из топика температуры.</p>
<h3>Результат</h3>
<p>Вы настроили рабочий поток на основе MQTT-сообщений. В пределах этого потока сервер умного дома Node-RED отслеживает изменения полученной с датчика температуры информации и при необходимости включает или выключает кондиционер.</p>
<p>Далее вы можете настроить отправку сообщений о температуру и состоянии кондиционера в Telegram.</p>
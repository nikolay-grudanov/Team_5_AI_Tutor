---
source_image: page_058.png
page_number: 58
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 38.17
tokens: 7751
characters: 2294
timestamp: 2025-12-24T09:11:34.034980
finish_reason: stop
---

close(fd);
if (gotdata(buf, len) == 0) {
    errno = save_errno;
    return 0;    /* все хорошо */
}
nodevrandom:
    errno = EIO;
    return -1;
}

В отличие от листинга 2.1, в листинге 2.2 производятся некоторые проверки. Сравните, например, вызовы open() в точке ① и read() в точке ② с аналогичными вызовами в листинге 2.1: в безопасной версии проверяются значения, возвращенные функциями, и в случае ошибки файловый дескриптор закрывается и возвращается −1.

Различия между /dev/urandom и /dev/random в Linux

В различных версиях Unix используются разные PRNG. В Linux PRNG, код которого находится в файле drivers/char/random.c, вызывает функцию хеширования SHA-1 для преобразования исходных битов энтропии в надежные псевдослучайные биты. PRNG получает энтропию из различных источников (включая клавиатуру, мышь, диск и моменты прерываний) и имеет главный пул энтропии размером 512 байт, а также неблокирующий пул для /dev/urandom и блокирующий пул для /dev/random.

В чем разница между /dev/urandom и /dev/random? Вкратце: /dev/random пытается оценить количество энтропии и отказывается возвращать биты, если ее уровень слишком низок. На первый взгляд, идея здравая, но на самом деле таковой не является. Во-первых, алгоритмы оценки энтропии печально известны своей ненадежностью, противник может их легко обмануть (именно поэтому в системе Fortuna авторы отказались от оценивания энтропии, присутствовавшего в Yarrow). Во-вторых, у /dev/random довольно быстро заканчивается оцененная энтропия, что может привести к отказу от обслуживания, поскольку приложения должны будут ждать накопления новой энтропии. Таким образом, на практике /dev/random ничем не лучше /dev/urandom, но создает больше проблем, чем решает.

Оценивание энтропии в /dev/random

В Linux наблюдать, как изменяется оценка энтропии в /dev/random, можно, читая ее текущее значение, выраженное в битах, из файла /proc/sys/kernel/random/entropy_avail. Так, скрипт оболочки в листинге 2.3 сначала доводит оценку энтропии до минимума, прочитав 4 КБ из /dev/random, потом ждет, пока оценка не достигнет 128 бит, читает из /dev/random 64 бита и показывает новую оценку. Запустив этот скрипт, обратите внимание, что действия пользователя ускоряют восполнение энтропии (прочитанные байты печатаются на stdout в кодировке base64).
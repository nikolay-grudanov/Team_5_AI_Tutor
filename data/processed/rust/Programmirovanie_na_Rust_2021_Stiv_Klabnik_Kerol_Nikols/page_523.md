---
source_image: page_523.png
page_number: 523
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 33.91
tokens: 7541
characters: 2168
timestamp: 2025-12-24T10:59:37.276783
finish_reason: stop
---

ляется в комплекте, поэтому нам не нужно было добавлять ее к зависимостям в Cargo.toml. Упаковка proc_macro представляет собой API компилятора, который позволяет читать код Rust и манипулировать им из нашего кода.

Упаковка syn проводит разбор кода Rust из строкового значения в структуру данных, с которой мы можем выполнять операции. Упаковка quote превращает структуры данных syn обратно в код Rust. Эти упаковки значительно упрощают выполнение разбора любого вида кода Rust, который мы, возможно, захотели бы обработать: написание полного анализатора кода Rust — задача не из простых.

Функция hello_macro_derive вызывается, когда пользователь библиотеки указывает для типа #[derive (HelloMacro)]. Это возможно, потому что здесь мы аннотировали функцию hello_macro_derive с proc_macro_derive и указали имя HelloMacro, которое соответствует имени нашего типажа. Этому соглашению следует большинство процедурных макрокоманд.

Функция hello_macro_derive сначала конвертирует input из TokenStream в структуру данных, которую мы затем можем интерпретировать и выполнять с ней операции. Вот тут и вступает в игру syn. Функция parse в syn берет TokenStream и возвращает структуру DeriveInput, представляющую разобранный код Rust. Листинг 19.32 показывает соответствующие части структуры DeriveInput, которые мы получаем при разборе строки struct Pancakes;.

Листинг 19.32. Экземпляр структуры DeriveInput, который мы получаем при разборе кода, имеющего атрибут макрокоманды из листинга 19.30

DeriveInput {
    // --пропуск--

    ident: Ident {
        ident: "Pancakes",
        span: #0 bytes(95..103)
    },
    data: Struct(
        DataStruct {
            struct_token: Struct,
            fields: Unit,
            semi_token: Some(
                Semi
            )
        }
    )
}

Поля этой структуры показывают, что код Rust, который мы разобрали, является пустой (unit) структурой с ident (идентификатором, означающим имя) типа Pancakes. В этой структуре есть и другие поля для описания всех видов кода Rust. Для получения дополнительной информации обратитесь к документации о syn для DeriveInput на https://docs.rs/syn/0.14.4/syn/struct.DeriveInput.html.
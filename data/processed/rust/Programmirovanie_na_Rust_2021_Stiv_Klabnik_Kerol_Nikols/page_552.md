---
source_image: page_552.png
page_number: 552
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 33.61
tokens: 7494
characters: 2003
timestamp: 2025-12-24T11:00:21.008014
finish_reason: stop
---

Отправка запросов нитям исполнения по каналам

Теперь мы займемся проблемой, касающейся того, что замыкания, передаваемые в функцию thread::spawn, абсолютно ничего не делают. В настоящее время мы получаем замыкание, которое хотим исполнить, в методе execute. Но нам нужно дать функции thread::spawn замыкание, подлежащее выполнению при возникновении каждого экземпляра структуры Worker во время создания ThreadPool.

Мы хотим, чтобы вновь создаваемые структуры Worker извлекали программный код, подлежащий выполнению, из очереди, хранящейся в пуле ThreadPool, и отправляли этот код в поток структуры Worker для выполнения.

В главе 16 вы узнали о каналах — простом способе связи между двумя потоками, который идеально подходит для данной ситуации. Мы будем использовать канал, функционирующий в качестве очереди заданий, а метод execute будет отправлять задание из ThreadPool в экземпляры Worker, которые будут отправлять это задание в свой поток. Вот план действий:

1. Пул ThreadPool будет создавать канал и стоять на отправляющей стороне канала.
2. Каждый работник Worker будет стоять на принимающей стороне канала.
3. Мы будем создавать новую структуру Job, содержащую замыкание для отправки по каналу.
4. Метод execute будет отправлять задание, которое он хочет исполнить, по передающей стороне канала.
5. В своем потоке Worker будет циклически перебирать принимающую сторону канала и исполнять замыкания любых заданий, которые он будет получать.

Давайте начнем с создания канала в функции ThreadPool::new и хранения отправляющей стороны в экземпляре типа ThreadPool, как показано в листинге 20.16. Структура Job пока ничего не содержит, но это тип элемента, который мы отправляем по каналу.

Листинг 20.16. Модификация структуры ThreadPool для хранения отправляющего конца канала, который отправляет экземпляры типа Job

src/lib.rs

```rust
// --пропуск--
use std::sync::mpsc;

pub struct ThreadPool {
    workers: Vec<Worker>,
    sender: mpsc::Sender<Job>,
}

struct Job;

impl ThreadPool {
```
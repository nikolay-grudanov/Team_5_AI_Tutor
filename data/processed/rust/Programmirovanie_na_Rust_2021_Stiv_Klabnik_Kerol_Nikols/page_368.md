---
source_image: page_368.png
page_number: 368
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 30.50
tokens: 7503
characters: 1949
timestamp: 2025-12-24T10:55:27.062925
finish_reason: stop
---

Использование Box<T> для получения рекурсивного типа с известным размером

Компилятор не может определить объем пространства, который следует выделить для типов, определенных рекурсивно, поэтому выдает ошибку в листинге 15.4. Но ошибка все-таки включает в себя полезную рекомендацию¹:

= help: insert indirection (e.g., a `Box`, `Rc`, or `&`) at some point to make `List` representable

В этой рекомендации косвенное обращение означает, что вместо прямого хранения значения мы изменим структуру данных так, чтобы хранить значение косвенно, сохраняя указатель на значение.

Поскольку Box<T> является указателем, Rust всегда знает, сколько места требуется для Box<T>: размер указателя не меняется в зависимости от объема данных, на которые он указывает. Это означает, что мы можем поместить указатель Box<T> внутрь варианта Cons вместо еще одного значения типа List. Box<T> будет указывать на следующее значение типа List, которое будет находиться в куче, а не внутри варианта Cons. Концептуально у нас по-прежнему список, созданный с помощью списков, «содержащих» другие списки, но теперь эта реализация больше похожа на размещение элементов рядом друг с другом, а не внутри друг друга.

Мы можем изменить определение перечисления List из листинга 15.2 и использование списка в листинге 15.3 на код в листинге 15.5, который будет компилироваться.

Листинг 15.5. Определение списка, который использует умный указатель Box<T>, чтобы иметь известный размер

src/main.rs

enum List {
    Cons(i32, Box<List>),
    Nil,
}

use crate::List::{Cons, Nil};

fn main() {
    let list = Cons(1,
        Box::new(Cons(2,
            Box::new(Cons(3,
                Box::new(Nil))))));
}

Вариант Cons потребует размер типа i32 плюс пространство для хранения данных умного указателя Box. Вариант Nil не сохраняет никаких значений, поэтому ему

¹ = справка: вставьте косвенное обращение (например, `Box`, `Rc` или `&`) в какой-то точке, сделав `List` представимым
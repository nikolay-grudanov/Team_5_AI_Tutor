---
source_image: page_388.png
page_number: 388
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 29.49
tokens: 7520
characters: 2134
timestamp: 2025-12-24T10:55:56.601365
finish_reason: stop
---

let percentage_of_max = self.value as f64 / self.max as f64;

    if percentage_of_max >= 1.0 {
        self.messenger.send("Ошибка: Вы превысили свою квоту!");
    } else if percentage_of_max >= 0.9 {
        self.messenger.send("Срочное предупреждение: Вы израсходовали свыше 90% своей квоты!");
    } else if percentage_of_max >= 0.75 {
        self.messenger.send("Предупреждение: Вы израсходовали свыше 75% своей квоты!");
    }
}

Одна из важных частей этого кода заключается в том, что типаж Messenger имеет один метод под названием send, который берет неизменяемую ссылку на self и текст сообщения ①. Это тот интерфейс, который должен быть у имитационного объекта. Другая важная часть заключается в том, что мы хотим проверить поведение метода set_value в структуре LimitTracker ②. Мы можем изменить то, что передаем внутрь для параметра value, но метод set_value не возвращает ничего, что бы мы могли использовать для проверочных утверждений. Мы хотим иметь возможность сказать, что если мы создадим структуру LimitTracker с чем-то, что реализует типаж Messenger, и конкретным значением для поля max, то, когда мы передаем разные числа для поля value, мессенджер должен отправить соответствующие сообщения.

Нам нужен mock-объект, который вместо отправки электронной почты или текстового сообщения при вызове метода send будет отслеживать только те сообщения, которые должен. Мы можем создать новый экземпляр имитационного объекта и структуру LimitTracker, которая использует этот имитационный объект, вызвать метод set_value для LimitTracker, а затем проверить, что у имитационного объекта нужные сообщения. Листинг 15.21 показывает попытку реализовать имитационный объект, чтобы выполнить поставленную задачу, но контролер заимствования не разрешает это сделать.

Листинг 15.21. Попытка реализовать структуру MockMessenger, которая запрещена контролером заимствования

src/lib.rs

#[cfg(test)]
mod tests {
    use super::*;

    struct MockMessenger {
        sent_messages: Vec<String>,
    }

    impl MockMessenger {
        fn new() -> MockMessenger {
            MockMessenger { sent_messages: vec![] }
        }
    }
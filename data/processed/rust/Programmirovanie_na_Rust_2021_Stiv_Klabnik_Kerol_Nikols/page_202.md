---
source_image: page_202.png
page_number: 202
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 33.69
tokens: 7584
characters: 2378
timestamp: 2025-12-24T10:51:05.098160
finish_reason: stop
---

Краткая форма распространения ошибок — оператор ?

Листинг 9.7 показывает реализацию функции read_username_from_file («прочитать имя пользователя из файла»), которая имеет ту же функциональность, что и в листинге 9.6, но данная реализация использует оператор ?.

Листинг 9.7. Функция, которая возвращает ошибки в вызывающий код с помощью оператора ?

src/main.rs

use std::io;
use std::io::Read;
use std::fs::File;

fn read_username_from_file() -> Result<String, io::Error> {
    let mut f = File::open("hello.txt")?;
    let mut s = String::new();
    f.read_to_string(&mut s)?;
    Ok(s)
}

Если поместить оператор ? после значения типа Result, то он будет работать почти так же, как выражения match, которые мы определяли для обработки значений Result в листинге 9.6. Если значение типа Result равно Ok, то из этого выражения будет возвращено значение внутри Ok и программа продолжит работу. Если же значение равно Err, то из всей функции будет возвращено Err, как если бы мы использовали ключевое слово return, а значение ошибки распространится в вызывающий код.

Существует разница в том, что делает выражение match из листинга 9.6 и оператор ?: значения ошибок, при которых вызывается оператор ?, проходящий через функцию from. Эта функция определена в типаже From в стандартной библиотеке и используется для конвертирования ошибок из одного типа в другой. Когда оператор ? вызывает функцию from, полученный тип ошибки конвертируется в ошибку, определенную в типе, возвращаемом текущей функцией. Это полезно, когда функция возвращает один тип ошибки, представляя таким образом все варианты сбоя функции, даже если ее части не срабатывают по разным причинам. Пока каждый тип ошибки реализует функцию from, определяя способ своего конвертирования в возвращаемый тип ошибки, оператор ? позаботится о конвертации автоматически.

В контексте листинга 9.7 оператор ? в конце вызова функции File::open будет возвращать значение внутри Ok в переменную f. Если произойдет ошибка, то оператор ? будет возвращаться из всей функции досрочно и передавать любое значение Err в вызывающий код. То же самое относится и к оператору ? в конце вызова метода read_to_string.

Оператор ? устраняет большой объем стереотипности и упрощает реализацию этой функции. Мы могли бы сократить этот код еще больше, выстроив вызовы методов в цепочку сразу после оператора ?, как показано в листинге 9.8.
---
source_image: page_562.png
page_number: 562
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 36.35
tokens: 7515
characters: 2120
timestamp: 2025-12-24T11:00:43.262498
finish_reason: stop
---

закрытием. Затем мы реализуем способ, который будет сообщать потокам, что они должны прекратить принимать новые запросы и выключиться. Для того чтобы увидеть этот код в действии, модифицируем сервер так, чтобы он принимал только два запроса перед тем, как корректно завершать работу своего пула потоков.

Реализация типажа Drop для ThreadPool

Давайте начнем с реализации типажа Drop в пуле потоков исполнения. Когда пул отбрасывается, все потоки должны быть собраны с тем, чтобы они завершили работу. В листинге 20.23 показана первая попытка реализации типажа Drop. Этот код пока не очень хорошо работает.

Листинг 20.23. Сбор всех потоков, когда пул потоков исполнения выходит из области видимости

src/lib.rs

impl Drop for ThreadPool {
    fn drop(&mut self) {
        for worker in &mut self.workers {
            println!("Отключение работника {}", worker.id);
            worker.thread.join().unwrap();
        }
    }
}

Сначала мы перебираем в цикле каждого работника пула потоков исполнения в workers ①. Для этого используем &mut, потому что self является изменяемой ссылкой, и нам также нужно иметь возможность изменять Worker. Для каждого работника мы выводим сообщение о том, что данный работник отключается ②, а затем вызываем join для потока этого работника ③. Если вызов join оказывается неуспешным, то используем метод unwrap, который вынуждает компилятор поднять панику и перейти к некорректному отключению.

Вот ошибка, которую мы получаем при компиляции этого кода¹:

error[E0507]: cannot move out of borrowed content
 --> src/lib.rs:65:13
  |
65 |         worker.thread.join().unwrap();
  |         ^^^^^^ cannot move out of borrowed content

Указанная ошибка говорит о том, что нельзя вызвать метод join, потому что у нас есть только неизменяемое заимствование каждого Worker, а join берет свой аргумент во владение. Для решения этой проблемы нужно переместить поток из экземпляра Worker, который владеет полем thread, чтобы метод join мог поглотить поток. Мы сделали это в листинге 17.15: если вместо этого Worker содержит

¹ ошибка[E0507]: не получается переместить из заимствованного содержимого
---
source_image: page_579.png
page_number: 579
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 54.40
tokens: 11773
characters: 1977
timestamp: 2025-12-24T10:42:55.146356
finish_reason: stop
---

типа во время выполнения кода. Нам нужен макрос для генерации кода во время компиляции.

Следующим шагом является определение процедурного макроса. На момент написания этой статьи процедурные макросы должны быть в собственном крейте. Со временем это ограничение может быть отменено. Соглашение о структурировании крейтов и макросов является следующим: для крейта с именем `foo`, его пользовательский, крейт с выводимым процедурным макросом называется `foo_derive`. Давайте начнём с создания нового крейта с именем `hello_macro_derive` внутри проекта `hello_macro`:

$ cargo new hello_macro_derive --lib

Наши два крейта тесно связаны, поэтому мы создаём процедурный макрос-крейт в каталоге крейта `hello_macro`. Если мы изменим определение типажа в `hello_macro`, то нам придётся также изменить реализацию процедурного макроса в `hello_macro_derive`. Два крейта нужно будет опубликованы отдельно и программисты, использующие эти крейты, должны будут добавить их как зависимости, а затем добавить их в область видимости. Мы могли вместо этого сделать так, что крейт `hello_macro` использует `hello_macro_derive` как зависимость и реэкспортирует код процедурного макроса. Однако то, как мы структурировали проект, делает возможным программистам использовать `hello_macro` даже если они не хотят `derive` функциональность.

Нам нужно объявить крейт `hello_macro_derive` как процедурный макрос-крейт. Также понадобятся функционал из крейтов `syn` и `quote`, как вы увидите через мгновение, поэтому нам нужно добавить их как зависимости. Добавьте следующее в файл Cargo.toml для `hello_macro_derive`:

Файл: hello_macro_derive/Cargo.toml

[lib]
proc-macro = true

[dependencies]
syn = "1.0"
quote = "1.0"

Чтобы начать определение процедурного макроса, поместите код листинга 19-31 в ваш файл src/lib.rs крейта `hello_macro_derive`. Обратите внимание, что этот код не скомпилируется пока мы не добавим определение для функции `impl_hello_macro`.

Файл: hello_macro_derive/src/lib.rs
---
source_image: page_594.png
page_number: 594
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 59.64
tokens: 11922
characters: 2525
timestamp: 2025-12-24T02:02:44.559073
finish_reason: stop
---

3 Это сопрограмма, которую мы должны передать методу asyncio.start_server; ее аргументами являются asyncio.StreamReader и asyncio.StreamWriter.
4 В этом цикле обрабатывается сеанс, который продолжается до получения любого управляющего символа от клиента.
5 Метод StreamWriter.write — не сопрограмма, а обычная функция; в этой строке выводится приглашение ?>.
6 Метод StreamWriter.drain сбрасывает буфер записи; это сопрограмма, поэтому вызывать ее следует с помощью yield from.
7 Метод StreamWriter.readline — сопрограмма, он возвращает объект типа bytes.
8 Исключение UnicodeDecodeError может возникнуть, если клиент Telnet посылает управляющий символ; в таком случае мы для простоты считаем, что получен нулевой символ.
9 Здесь возвращается удаленный адрес сокета.
10 Протоколируем запрос на консоли сервера.
11 Выходим из цикла, если получен управляющий или нулевой символ.
12 Возвращается генератор, который отдает строки, содержащие кодовую позицию Unicode, сам символ и его имя (например, U+0039\t9\tDIGIT NINE); для простоты я создаю из генератора список. I
13 Отправляем клиенту строки, преобразованные в последовательность байтов в предположении кодировки UTF-8, в конец каждой строки добавляем символы возврата каретки и перевода строки; обратите внимание, что аргумент — генераторное выражение.
14 Выводим строку состояния, например 627 matches for 'digit'.
15 Сбрасываем буфер вывода.
16 Протоколируем ответ на консоли сервера.
17 Протоколируем конец сеанса на консоли сервера.
18 Закрываем StreamWriter.

Слово «queries» в имени сопрограммы handle_queries указано во множественном числе, потому что эта сопрограмма начинает интерактивный сеанс и обрабатывает по несколько запросов от каждого клиента.

Отметим, что ввод-вывод в примере 18.14 производится в байтах. Мы должны декодировать строки, приходящие из сети, и закодировать отправляемые строки. В Python 3 кодировкой по умолчанию является UTF-8, ее мы и используем.

Небольшая проблема заключается в том, что некоторые методы ввода-вывода являются сопрограммами и должны управляться посредством yield from, тогда как другие — обычные функции. Например, StreamWriter.write — обычная функция, поскольку предполагается, что в большинстве случаев она ничего не блокирует, т. к. пишет в буфер. С другой стороны, метод StreamWriter.drain, который сбрасывает буфер, выполняя реальный вывод, — сопрограмма, как и метод Streamreader.readline. Когда я работал над книгой, в документацию по asyncio API было внесено важное улучшение: все сопрограммы явно обозначены.
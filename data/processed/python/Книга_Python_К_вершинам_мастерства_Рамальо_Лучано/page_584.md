---
source_image: page_584.png
page_number: 584
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 61.08
tokens: 12012
characters: 2836
timestamp: 2025-12-24T02:02:09.799135
finish_reason: stop
---

590 Глава 18. Применение пакета asyncio для организации...

5 Обертываем итератор функцией tqdm, чтобы можно было отобразить ход выполнения.

6 Обходим завершенные будущие объекты; этот цикл очень похож на цикл в функции download_many из примера 17.14; отличия связаны по большей части с обработкой исключений, что обусловлено различиями в библиотеках работы с HTTP (requests и aiohttp).

7 Получить результат asyncio.Future проще всего, воспользовавшись yield from вместо обращения к future.result().

8 Любое исключение в download_one обертывается исключением FetchError.

9 Получаем из объекта FetchError код страны, при скачивании флага которой произошло исключение.

10 Пытаемся извлечь сообщение об ошибке из объекта исходного исключения (__cause__).

11 Если в исходном исключении нет сообщения об ошибке, используем в этом качестве имя класса исходного исключения.

12 Подсчитываем исходы разных видов.

13 Возвращаем счетчик, как в других скриптах.

14 download_many просто создает экземпляр сопрограммы и передает его циклу обработки событий с помощью метода run_until_complete.

15 Когда все сделано, завершаем цикл обработки событий и возвращаем counts.

В примере 18.8 мы не могли воспользоваться отображением будущих объектов на коды стран, как в примере 17.14, потому что будущие объекты, возвращаемые функцией asyncio.as_completed, не обязательно совпадают с будущими объектами, переданными as_completed при вызове. Внутри себя asyncio подменяет одни будущие объекты другими, дающими тот же самый конечный результат7.

Раз не получается использовать будущие объекты в качестве ключей для поиска кода страны в словаре в случае ошибки, то мне пришлось написать собственный класс исключения FetchError (показан в примере 18.7). Объект FetchError обертывает сетевое исключение и хранит ассоциированный с ним код страны, что дает возможность вывести этот код в составе сообщения об ошибке при работе в режиме подробной информации. Если ошибки не было, то код страны становится доступен в виде результата выражения yield from future в начале цикла for.

На этом мы завершаем обсуждение примера использования asyncio, функционально эквивалентного рассмотренному ранее скрипту flags2_threadpool.py. Ниже мы улучшим скрипт flags2_asyncio.py, что позволит еще ближе познакомиться с пакетом asyncio.

По ходу обсуждения примера 18.7 я отметил, что функция save_flag осуществляет запись на диск, и ее следовало бы выполнять асинхронно. В следующем разделе, показано, как это сделать.

7 Подробное обсуждение этого вопроса можно найти в начатой мной теме в группе python-tulip, она озаглавлена «Which other futures my come out of asyncio.as_completed?» (http://bit.ly/1f6CBZx). Гвидо отвечает на мой вопрос и подробно рассказывает о реализации функции as_completed и о тесной связи между будущими объектами и сопрограммами в asyncio.
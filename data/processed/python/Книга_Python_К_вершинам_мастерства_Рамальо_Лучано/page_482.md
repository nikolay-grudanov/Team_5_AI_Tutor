---
source_image: page_482.png
page_number: 482
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 46.41
tokens: 11774
characters: 2015
timestamp: 2025-12-24T01:57:21.247081
finish_reason: stop
---

В примере 15.6 показана функция looking_glass в действии.

Пример 15.6. Тест функции контекстного менеджера looking_glass

```python
>>> from mirror_gen import looking_glass
>>> with looking_glass() as what:
...     print('Alice, Kitty and Snowdrop')
...     print(what)
...
pordwons dna yttik ,ecilA
YKCOWREBBAJ
>>> what
'JABBERWOCKY'
```

1 Единственное отличие от примера 15.2 — имя контекстного менеджера: looking_glass вместо LookingGlass.

По существу, декоратор contextlib.contextmanager обертывает функцию классом, который реализует методы __enter__ и __exit__4
Метод __enter__ этого класса выполняет следующие действия:

1. Вызывает генераторную функцию и запоминает объект-генератор — назовем его gen.
2. Вызывает next(gen), чтобы заставить генератор выполнить код до предложения yield.
3. Возвращает значение, отданное next(gen), чтобы его можно было связать с переменной в части as блока with.

По завершении блока with метод __exit__ выполняет следующие действия:

1. Смотрит, было ли передано исключение в параметре exc_type; если да, вызывает gen.throw(exception), в результате чего строка в теле генераторной функции, содержащая yield, возбуждает исключение.
2. В противном случае вызывает next(gen), что приводит к выполнению части генераторной функции после yield.

В примере 15.5 есть серьезный дефект: если в теле блока with возникает исключение, то интерпретатор Python перехватывает его и повторно возбуждает в выражении yield внутри looking_glass. Но здесь нет никакой обработки исключений, поэтому функция looking_glass аварийно завершится, не восстановив исходный метод sys.stdout.write и оставив тем самым систему в некорректном состоянии.

В примере 15.7 добавлена специальная обработка исключения ZeroDivisionError, в результате чего код стал эквивалентен примеру 15.3, основанному на классе.

4 Этот класс называется _GeneratorContextManager. Если хотите узнать, как он работает, загляните в его исходный код (http://bit.ly/1MM8AJJ) в файле Lib/contextlib.py из дистрибутива Python 3.4.
---
source_image: page_484.png
page_number: 484
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 46.80
tokens: 11860
characters: 2186
timestamp: 2025-12-24T01:57:26.095465
finish_reason: stop
---

Наличие блока try/finally (или блока with) вокруг yield — неизбежная плата за использование @contextmanager, потому что невозможно заранее знать, что пользователи контекстного менеджера будут делать внутри блока with7.

Пример 15.8. Контекстный менеджер для перезаписи файла на месте

import csv

with inplace(csvfilename, 'r', newline='') as (infh, outfh):
    reader = csv.reader(infh)
    writer = csv.writer(outfh)

    for row in reader:
        row += ['new', 'columns']
        writer.writerow(row)

Функция inplace — это контекстный менеджер, который предоставляет два описателя — infh и outfh — одного и того же файла, позволяющие одновременно читать и записывать файл. Это проще, чем функция fileinput.input из стандартной библиотеки (http://bit.ly/1HGr6Sq) (которая, кстати, тоже является контекстным менеджером).

Если вы хотите разобраться в исходном коде функции inplace (приведенном в статье по адресу http://bit.ly/1MM96aR), то ищите ключевое слово yield: все, что находится до него, связано с подготовкой контекста, т. е. созданием резервной копии и последующим открытием и отдачей описателей для чтения и записи, которые будут возвращены при вызове метода __enter__. В ходе обработки метода __exit__ после слова yield закрываются описатели файлов, а если что-то пошло не так, то файл восстанавливается из резервной копии.

Отметим, что использование слова yield в генераторе, который используется совместно с декоратором @contextmanager, не имеет ничего общего с итерированием. В примерах из этого раздела генераторная функция работает скорее, как сопрограмма: процедура, которая доходит до определенной точки, затем приостанавливается и дает возможность поработать клиентскому коду до тех пор, пока он не захочет возобновить выполнение процедуры с прерванного места. Сопрограммам посвящена глава 16.

Резюме

Мы начали эту главу с простого материала: обсуждения блоков else в предложениях for, while и try. Я полагаю, что если привыкнуть к неочевидной семантике части else в этих предложениях, то с ее помощью можно будет яснее выражать свои намерения.

7 Это прямая цитата из замечания Леонардо Рохаэля, одного из технических рецензентов книги. Отлично сказано, Лео!
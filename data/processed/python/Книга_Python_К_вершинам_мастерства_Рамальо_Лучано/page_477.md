---
source_image: page_477.png
page_number: 477
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 41.21
tokens: 11779
characters: 1999
timestamp: 2025-12-24T01:57:01.847877
finish_reason: stop
---

Контекстные менеджеры и блоки with

Первый маркер в примере 15.1 отмечает тонкий, но важный момент: объект контекстного менеджера — это результат вычисления выражения после слова with, но значение, связанное с переменной в части as, — результат вызова метода __enter__ объекта контекстного менеджера.

В примере 15.1 функция open() возвращает экземпляр класса TextIOWrapper, а его метод __enter__ возвращает self. Но вообще-то метод __enter__ может возвращать любой другой объект, не обязательно сам контекстный менеджер.

Когда поток управления покидает блок with любым способом, вызывается метод __exit__ контекстного менеджера, а не объекта, возвращенного методом __enter__.

Часть as в предложении with необязательна. В случае open она необходима, чтобы получить ссылку на файл, но некоторые контекстные менеджеры возвращают None за неимением чего-то полезного.

В примере 15.2 показана работа шутливого контекстного менеджера, единственный смысл которого — подчеркнуть различие между самим менеджером и объектом, который возвращает его метод __enter__.

Пример 15.2. Тест класса контекстного менеджера LookingGlass

```python
>>> from mirror import LookingGlass
>>> with LookingGlass() as what:
...     print('Alice, Kitty and Snowdrop')
...     print(what)
... pordwons dna yttik ,ecilA
... YKCOWREBBAJ
>>> what
'JABBERWOCKY'
>>> print('Back to normal.')
Back to normal.
```

1 Контекстный менеджер — экземпляр класса LookingGlass; Python вызывает метод __enter__ контекстного менеджера и связывает результат с переменной what.
2 Печатаем str, а затем значение переменной what.
3 Любая печатаемая строка выводится задом наперед.
4 Блок with завершился. Как видим, метод __enter__ вернул значение 'JABBERWOCKY', сохраненное в переменной what.
5 Но печатаемые строки больше не инвертируются.

В примере 15.3 показана реализация класса LookingGlass.

Пример 15.3. mirror.py: класс контекстного менеджера LookingGlass

```python
class LookingGlass:

    def __enter__(self):
        import sys
```
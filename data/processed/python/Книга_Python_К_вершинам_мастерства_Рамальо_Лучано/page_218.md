---
source_image: page_218.png
page_number: 218
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 45.27
tokens: 11806
characters: 1994
timestamp: 2025-12-24T01:44:50.707716
finish_reason: stop
---

series.append(new_value)
total = sum(series)
return total/len(series)

return averager

При обращении к make_averager возвращается объект-функция averager. При каждом вызове averager добавляет переданный аргумент в конец списка series и вычисляет текущее среднее, как показано в примере 7.10.

Пример 7.10. Тестирование функции из примера 7.9

>>> avg = make_averager()
>>> avg(10)
10.0
>>> avg(11)
10.5
>>> avg(12)
11.0

Обратите внимание на сходство обоих примеров: мы обращаемся к Averager() или к make_averager(), чтобы получить вызываемый объект avg, который обновляет временной ряд и вычисляет текущее среднее. В примере 7.8 avg — экземпляр Averager, а в примере 7.9 — внутренняя функция averager. И в том, и в другом случае мы просто вызываем avg(n), чтобы добавить n в ряд и вычислить новое среднее.

Совершенно ясно, где хранит историю объект avg класса Averager: в атрибуте экземпляра self.series. Но где находит series функция avg из второго примера?

Обратите внимание, что series — локальная переменная make_averager, потому что инициализация series = [] производится в теле этой функции. Но к моменту вызова avg(10) функция make_averager уже вернула управление, и ее локальная область видимости уничтожена. Внутри averager series является свободной переменной. Этот технический термин означает, что переменная не связана в локальной области видимости. См. рис. 7.1.

Инспекция возвращенного объекта averager показывает, что Python хранит имена локальных и свободных переменных в атрибуте __code__, который представляет собой откомпилированное тело функции. Это показано в примере 7.11.

Пример 7.11. Инспекция функции, созданной функцией make_averager из примера 7.9

>>> avg.__code__.co_varnames
('new_value', 'total')
>>> 'avg.__code__.co_freevars
('series',)

Привязка переменной series хранится в атрибуте __closure__ возвращенной функции avg. Каждому элементу avg.__closure__ соответствует имя в avg.__code__.co_freevars. Эти элементы называются ячейками (cells), и у каждого
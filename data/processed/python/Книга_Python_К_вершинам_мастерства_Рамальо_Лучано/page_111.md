---
source_image: page_111.png
page_number: 111
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 45.56
tokens: 11973
characters: 2464
timestamp: 2025-12-24T01:39:46.608921
finish_reason: stop
---

Под капотом dict и set

го устройства хэш-таблицы станет понятно, почему порядок ключей, на первый взгляд, является случайным и нестабильным.

Хэш-таблицы в словарях

Ниже дается лишь общее представление о том, как хэш-таблица используется в Python для реализации класса dict. Многие детали опущены — в коде CPython есть ряд оптимизаций5 — но в целом описание достаточно точное.

Чтобы упростить дальнейшее изложение, мы сначала сосредоточимся на устройстве класса dict, а затем распространим те же идеи на множества.

Хэш-таблица — это разреженный массив (массив, в котором имеются незаполненные позиции). В стандартных англоязычных учебниках по структурам данных ячейки хэш-таблицы называются «bucket». В хэш-таблице dict каждому элементу соответствует ячейка, содержащая два поля: ссылку на ключ и ссылку на значение элемента. Поскольку размер всех ячеек одинаков, доступ к отдельной ячейке производится по смещению.

Python стремится оставить не менее трети ячеек пустыми; если хэш-таблица становится чрезмерно заполненной, то она копируется в новый участок памяти, где есть место для большего числа ячеек.

Для помещения элемента в хэш-таблицу нужно первым делом вычислить хэш-значение ключа элемента. Это делает встроенная функция hash(), которую мы рассмотрим ниже.

Хэш-значения и равенство

Встроенная функция hash() со встроенными типами работает напрямую, а для пользовательских обращается к методу __hash__. Если два объекта равны в смысле оператора сравнения, то их хэш-значения также должны быть равны, иначе алгоритм хэш-таблицы работать не будет. Например, коль скоро 1 == 1.0 истинно, то и hash(1) == hash(1.0) должно быть истинно, хотя внутренние представления int и float совершенно различны6.

Кроме того, хэш-значения лишь тогда будут эффективны в качестве индексов хэш-таблицы, когда они как можно более равномерно распределены по всему пространству индексов. Это означает, что в идеале хэш-значения похожих, но неодинаковых объектов, должны сильно различаться. В примере 3.16 приведен вывод скрипта для сравнения битовых представлений хэш-значений. Обратите

5 В файле dictobject.c, являющемся частью CPython (http://hg.python.org/cpython/file/tip/Objects/dictobject.c), нет недостатка в комментариях. См. также ссылку на книгу «Beautiful Code» в разделе «Дополнительная литература».
6 Раз уж мы упомянули тип int, раскроем одну деталь реализации CPython: хэш-значение числа типа int, умещающегося в машинное слово, совпадает с самим числом.
---
source_image: page_497.png
page_number: 497
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 49.90
tokens: 11828
characters: 2121
timestamp: 2025-12-24T01:58:06.124985
finish_reason: stop
---

Завершение сопрограммы и обработка исключений

демонстрируется использование декорированной сопрограммы averager из примера 16.6.

Пример 16.7. Как необработанное исключение аварийно завершает сопрограмму

```python
>>> from coroaverager1 import averager
>>> coro_avg = averager()
>>> coro_avg.send(40) # 1
40.0
>>> coro_avg.send(50)
45.0
>>> coro_avg.send('spam') # 2
Traceback (most recent call last):
...
TypeError: unsupported operand type(s) for +=: 'float' and 'str'
>>> coro_avg.send(60) # 3
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
StopIteration
```

1 Сопрограмме averager(), декорированной @coroutine, можно сразу отправлять значения.
2 Отправка нечислового значения приводит к исключению в сопрограмме.
3 Поскольку исключение не обработано самой сопрограммой, она завершается. Любая попытка вновь активировать сопрограмму вызовет исключение StopIteration.

Причина ошибки в том, что отправленное значение 'spam' нельзя прибавить к переменной total.

Пример 16.7 показывает возможный способ завершения сопрограммы: послать некоторое специальное значение, которое сопрограмма интерпретирует как признак завершения. Удобными кандидатами на эту роль являются константные встроенные синглтоны, например None и Ellipsis. У Ellipsis к тому же есть то достоинство, что в обычных потоках данных он практически не встречается. Я также видел, как в качестве признака используют StopIteration — сам класс, а не его экземпляр (и без возбуждения исключения такого типа), т. е. таким образом: my_coro.send(StopIteration).

Начиная с версии Python 2.5, у объектов-генераторов есть два метода, которые позволяют клиенту явно отправить сопрограмме исключение: throw и close:

```python
generator.throw(exc_type[, exc_value[, traceback]])
```

Приводит к тому, что выражение yield, в котором генератор приостановлен, возбуждает указанное исключение. Если генератор обрабатает исключение, то выполнение продолжится до следующего yield, а отданное значение станет значением вызова generator.throw. Если же исключение не обработано генератором, то оно распространится в контекст вызывающей стороны.
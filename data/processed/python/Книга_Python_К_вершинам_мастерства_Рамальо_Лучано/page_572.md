---
source_image: page_572.png
page_number: 572
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 48.67
tokens: 11866
characters: 2241
timestamp: 2025-12-24T02:01:34.453908
finish_reason: stop
---

Загрузка с применением asyncio и aiohttp

В версии Python 3.4 сам модуль asyncio поддерживает только протоколы TCP и UDP. Для HTTP и других протоколов понадобятся сторонние пакеты. Для программирования асинхронных клиентов и серверов HTTP в настоящее время практически все пользуются пакетом aiohttp.

В примере 18.5 показан полный код скрипта загрузки флагов flags_asyncio.py. Ниже приведено общее описание его работы.

1. Все начинается в функции download_many, где мы загружаем в цикл обработки событий несколько объектов-сопрограмм, полученных от download_one.
2. Цикл обработки событий asyncio активирует все сопрограммы по очереди.
3. Когда клиентская сопрограмма, например get_flag, выполняет yield from, чтобы делегировать работу библиотечной сопрограмме, например aiohttp.request, управление возвращается циклу обработки событий, который может выполнить любую другую из ранее запланированных сопрограмм.
4. В цикле обработки событий для получения уведомлений о завершении блокирующих операций используется низкоуровневый API, основанный на обратных вызовах.
5. Когда такое случается, главный цикл отправляет результат приостановленной сопрограмме.
6. Затем выполнение сопрограммы продолжается до следующего yield, например yield from resp.read() в get_flag. Цикл обработки событий вновь получает управление. Шаги 4, 5 и 6 повторяются до выхода из цикла обработки событий.

Это напоминает пример, который мы рассматривали в разделе «Моделирование работы таксопарка» главы 16, где в главном цикле поочередно запускалось несколько процессов такси. Когда процесс некоторого такси уступал управление, главный цикл планировал следующее событие этого такси (в будущем) и переходил к активации следующего такси в очереди. Моделирование такси гораздо проще, его главный цикл легко понять. Но общий поток управления в asyncio такой же: однопоточная программа, в которой главный цикл активирует находящиеся в очереди сопрограммы одну за другой. Каждая сопрограмма выполняет какие-то действия, а затем уступает управление главному циклу, который активирует следующую сопрограмму.

Теперь рассмотрим пример 18.5 детально.

Пример 18.5. flags_asyncio.py: асинхронный скрипт загрузки с применением asyncio и aiohttp

import asyncio

import aiohttp
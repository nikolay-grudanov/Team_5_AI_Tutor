---
source_image: page_494.png
page_number: 494
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 46.50
tokens: 11881
characters: 2141
timestamp: 2025-12-24T01:57:49.206677
finish_reason: stop
---

count += 1
average = total/count

1 В этом бесконечном цикле сопрограмма будет принимать значения и порождать результаты, пока вызывающая сторона их посылает. Сопрограмма завершится, когда вызывающая сторона вызовет ее метод .close() или если ее уничтожит сборщик мусора, увидев, что на нее не осталось ни одной ссылки.

2 Здесь предложение yield используется, чтобы приостановить сопрограмму, отдать результат вызывающей стороне и — впоследствии — получить значение, посланное вызывающей стороной, после чего выполнение бесконечного цикла продолжится.

У сопрограммы есть то преимущество, что total и count могут быть обычными локальными переменными, для запоминания контекста между вызовами не нужны ни переменные экземпляра, ни замыкания. В примере 16.4 приведены doctest-скрипты, демонстрирующие использование сопрограммы averager.

Пример 16.4. coroaverager0.py: doctest-скрипт, демонстрирующий использование сопрограммы вычисления накопительного среднего из примера 16.3

>>> coro_avg = averager() ①
>>> next(coro_avg) ②
>>> coro_avg.send(10) ③
10.0
>>> coro_avg.send(30)
20.0
>>> coro_avg.send(5)
15.0

① Создаем объект сопрограммы.
② Инициализируем ее, вызывая next.
③ Теперь мы в деле: каждый вызов .send(...) отдает текущее среднее.

В этом doctest-скрипте вызов next(coro_avg) заставляет сопрограмму дойти до yield, при этом будет отдано начальное значение average, равное None, поэтому в оболочке оно не печатается. В этот момент сопрограмма приостановлена и ждет отправки значения. В строке coro_avg.send(10) значение отправляется, после чего сопрограмма возобновляет работу, присваивает значение term, обновляет переменные total, count и average и начинает следующую итерацию цикла, на которой отдает average и ждет следующего члена последовательности.

У внимательного читателя, наверное, возник вопрос, как остановить работу объекта averager (coro_avg), — ведь цикл-то бесконечный. Мы ответим на этот вопрос в разделе «Завершение сопрограммы и обработка исключений» ниже.

Но прежде поговорим не о том, как завершить сопрограмму, а о том, как ее запустить. Инициализация сопрограммы — необходимый шаг, о котором легко забыть.
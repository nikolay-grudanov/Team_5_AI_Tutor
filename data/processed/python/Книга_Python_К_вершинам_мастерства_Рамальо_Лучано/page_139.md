---
source_image: page_139.png
page_number: 139
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 60.27
tokens: 12035
characters: 2851
timestamp: 2025-12-24T01:41:22.410343
finish_reason: stop
---

Обработка текстовых файлов

5 Вывод производится на консоль, поэтому sys.stdout.isatty() равно True.
6 Поэтому sys.stdout.encoding такая же, как кодировка для консоли.

Если перенаправить вывод в файл:

Z:\>python default_encodings.py > encodings.log

То sys.stdout.isatty() становится равным False и sys.stdout.encoding устанавливается путем обращения к locale.getpreferredencoding(), т. е. 'cp1252' на данной машине.

Отметим, что в примере 4.12 встречаются четыре разных кодировки.

• Если опустить аргумент encoding при открытии файла, то умолчание определяется методом locale.getpreferredencoding() ('cp1252' в примере 4.12).
• Кодировка sys.stdout/stdin/stderr определяется переменной окружения PYTHONIOENCODING (http://bit.ly/1IqvCUZ), если она задана, иначе либо наследуется от консоли, либо определяется методом locale.getpreferredencoding() в случае, когда ввод-вывод перенаправлен на файл.
• Функция sys.getdefaultencoding() используется самим интерпретатором Python для преобразования двоичных данных в строку и обратно. В Python 3 это делается не так часто, но все же делается6. Изменение этого параметра не поддерживается7.
• Функция sys.getfilesystemencoding() применяется для кодирования и декодирования имен файлов (но не их содержимого). Она вызывается, когда open() получает имя файла в виде строки str; если же имя файла задано аргументом типа bytes, то оно передается API операционной системы без изменения. В документе «Python Unicode HOWTO» (https://docs.python.org/3/howto/unicode.html) написано: «в Python для Windows имя mbcS используется для обозначения текущей сконфигурированной кодировки, какова бы она ни была». Акроним MBCS означает «Multi Byte Character Set» (многобайтовый набор символов), таковы были кодировки переменной длины gb2312 или Shift_JIS, которые раньше использовались в операционных системах Майкрософт, но UTF-8 к ним не относится. (На эту тему есть полезный ответ на сайте StackOverflow в статье «Различия между MBCS и UTF-8 в Windows» (http://bit.ly/1IqvRPV)).

6 Изучая этот вопрос, я не нашел, в каких ситуациях Python 3 сам преобразует bytes в str. Разработчик ядра Python Антуан Питру в списке рассылки comp.python.devel (http://bit.ly/1IqvSU2) пишет, что внутренние функции CPython, выполняющие такие преобразования, «используются в ру3k не часто».
7 В Python 2 функция sys.setdefaultencoding использовалась некорректно и из документации по Python 3 ее описание исключено. Предполагалось, что она будет использоваться разработчиками ядра в тех случаях, когда внутренняя кодировка по умолчанию еще не определена. В ветви обсуждения comp.python.devel (http://bit.ly/1IqvN2J) Марк-Андрэ Лембург (Marc-Andre Lemburg) говорит, что sys.setdefaultencoding никогда не должна вызываться из пользовательского кода, а единственные значения, поддерживаемые CPython, — 'ascii' в Python 2 и 'utf-8' в Python 3.
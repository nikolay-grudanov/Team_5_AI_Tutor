---
source_image: page_483.png
page_number: 483
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 47.32
tokens: 11892
characters: 2365
timestamp: 2025-12-24T01:57:26.502959
finish_reason: stop
---

Использование @contextmanager

Пример 15.7. mirror_gen_exc.py: контекстный менеджер на основе генератора, реализующий обработку исключений, — внешнее поведение такое же, как в примере 15.3

import contextlib
@contextlib.contextmanager
def looking_glass():
    import sys
    original_write = sys.stdout.write

    def reverse_write(text):
        original_write(text[::-1])

    sys.stdout.write = reverse_write
    msg = '' ①
    try:
        yield 'JABBERWOCKY'
    except ZeroDivisionError: ②
        msg = 'Пожалуйста, НЕ НАДО делить на нуль!'
    finally:
        sys.stdout.write = original_write ③
        if msg:
            print(msg) ④

① Создаем переменную для хранения возможного сообщения об ошибке; это первое изменение по сравнению с примером 15.5.
② Обрабатываем исключение ZeroDivisionError — устанавливаем сообщение об ошибке.
③ Восстанавливаем исходный метод sys.stdout.write.
④ Отображаем сообщение об ошибке, если оно не пусто.

Напомним, что, возвращая True, метод __exit__ уведомляет интерпретатор о том, что он обработал исключение; в этом случае интерпретатор подавляет исключение. С другой стороны, если __exit__ не вернул никакого значения явно, то интерпретатор получает значение по умолчанию None и распространяет исключение дальше. При наличии декоратора @contextmanager поведение по умолчанию изменяется на противоположное: метод __exit__, предоставляемый декоратором, предполагает, что любое исключение, посланное генератору, уже обработано и должно быть подавлено⁵. Если вы не хотите, чтобы декоратор @contextmanager подавлял исключение, то должны сами возбудить его повторно в декорированной функции⁶.

Интересный практический пример использования @contextmanager за пределами стандартной библиотеки дает контекстный менеджер для перезаписи файла на месте, созданный Мартином Питерсом (http://bit.ly/1MM96aR). В примере 15.8 показано, как он используется.

⁵ Исключение посылается генератору методом throw, который рассматривается в разделе «Завершение сопрограммы и обработка исключений» главы 16.
⁶ Такое соглашение принято, потому что при проектировании контекстных менеджеров генераторы не могли возвращать значения, разрешено было только отдавать их с помощью yield. Теперь это возможно, как объясняется в разделе «Возврат значения из сопрограммы» главы 16. Мы увидим, что возврат значения из генератора сводится к исключению.
---
source_image: page_476.png
page_number: 476
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 44.20
tokens: 11827
characters: 2047
timestamp: 2025-12-24T01:57:02.565535
finish_reason: stop
---

Глава 15. Контекстные менеджеры и блоки else

проблемы можно решить с помощью блокировки или программирования в стиле EAFP.

Принимая во внимание стиль EAFP, использование блоков else в предложениях try/except выглядит еще более оправданным.
А теперь перейдем к основной теме этой главы: могу чему предложению with.

Контекстные менеджеры и блоки with

Объекты контекстных менеджеров служат для управления предложением with, точно так же, как итераторы управляют предложением for.

Предложение with было задумано, для того чтобы упростить конструкцию try/finally, гарантирующую, что некоторая операция будет выполнена после блока, даже если этот блок прерван в результате исключения, предложения return или вызова sys.exit(). Код внутри части finally обычно освобождает критически важный ресурс или восстанавливает временно измененное состояние.

Протокол контекстного менеджера состоит из методов __enter__ и __exit__.
В начале блока with вызывается метод __enter__ контекстного менеджера. А роль части finally играет обращение к методу __exit__ контекстного менеджера в конце блока with.

Самый распространенный пример — гарантированное закрытие объекта файла, показанное в примере 15.1.

Пример 15.1. Использование объекта файла в качестве контекстного менеджера

```python
>>> with open('mirror.py') as fp: # ①
...     src = fp.read(60) # ②
...
>>> len(src)
60
>>> fp # ③
<_io.TextIOWrapper name='mirror.py' mode='r' encoding='UTF-8'>
>>> fp.closed, fp.encoding # ④
(True, 'UTF-8')
>>> fp.read(60) # ⑤
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
ValueError: I/O operation on closed file.
```

① Имя fp связано с открытым файлом, потому что метод __enter__ объекта-файла возвращает self.
② Читаем данные из fp.
③ Переменная fp все еще доступна².
④ Мы можем прочитать атрибуты объекта fp.
⑤ Но выполнить операцию ввода-вывода для fp по завершении блока with нельзя, т. к. уже был вызван метод TextIOWrapper.__exit__ и файл закрыт.

Блоки with не определяют новую область видимости — в отличие от функций и модулей.
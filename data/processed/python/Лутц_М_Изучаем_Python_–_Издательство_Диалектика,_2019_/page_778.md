---
source_image: page_778.png
page_number: 778
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 41.72
tokens: 7909
characters: 3015
timestamp: 2025-12-24T01:31:28.100028
finish_reason: stop
---

Пример: транзитивная перезагрузка модулей

В настоящем разделе будет создан инструмент работы с модулями, который связывает воедино и применяет несколько ранее рассмотренных тем и служит более крупным учебным примером, подходящим для завершения главы и части. В главе 23 обсуждалась перезагрузка модулей как способ подхвата изменений в коде без остановки и перезапуска программы. Однако при перезагрузке модуля Python перезагружает только файл этого конкретного модуля; он не делает автоматической перезагрузки модулей, которые были импортированы в перезагружаемом файле.

Скажем, если вы перезагружаете модуль А, в котором импортируются модули В и С, то перезагрузка применяется только к А, но не к В и С. Операторы внутри А, которые импортируют В и С, в течение перезагрузки выполняются повторно, но они всего лишь извлекают объекты уже загруженных модулей В и С (предполагая, что они были импортированы раньше). Ниже показан действительный, хотя и абстрактный код в файле A.py:

# A.py
import B    # Не перезагружается при перезагрузке А!
import C    # Просто импортирует уже загруженный модуль: действия отсутствуют
% python
>>> ...
>>> from imp import reload
>>> reload(A)

Таким образом, по умолчанию вы не можете рассчитывать на то, что перезагрузка транзитивно подхватит изменения во всех модулях в программе — взамен вам придется использовать множество вызовов reload для независимого обновления подкомпонентов. В итоге интерактивное тестирование крупных систем может потребовать значительного объема работы. Вы можете проектировать свои системы так, чтобы они перезагружали подкомпоненты автоматически, добавив вызовы reload в родительские модули вроде А, но тогда код модулей станет сложнее.

Инструмент рекурсивной перезагрузки

Более удачный подход предусматривает написание универсального инструмента, который будет делать транзитивную перезагрузку автоматически, просматривая атрибуты __dict__ пространств имен модулей и проверяя type каждого элемента, чтобы найти вложенные модули, подлежащие перезагрузке. Такая служебная функция могла бы вызывать себя рекурсивно для перемещения по произвольно сформированным и глубоким цепочкам зависимостей. Атрибуты модулей __dict__ были представлены в главе 23 и задействованы ранее в текущей главе, а вызов type объяснялся в главе 9; нам нужно просто объединить два инструмента.

В модуле reloadall.py, код которого приведен ниже, определяется функция reload_all, автоматически перезагружающая модуль, каждый импортируемый им модуль и т.д. вплоть до самого конца каждой цепочки импортирования. Она применяет словарь для отслеживания уже перезагруженных модулей, рекурсию для прохода по цепочкам импортирования и стандартный библиотечный модуль types, в котором просто предопределены результаты type для встроенных типов. Методика со словарем visited позволяет здесь избежать циклов, когда операции импортирования рекурсивны или избыточны, поскольку объекты модулей неизменяемы и поэтому могут быть словарными ключами; как объяснялось в главах 5 и 8, множество
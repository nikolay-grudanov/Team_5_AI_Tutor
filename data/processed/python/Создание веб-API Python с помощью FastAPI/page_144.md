---
source_image: page_144.png
page_number: 144
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 41.75
tokens: 8464
characters: 1845
timestamp: 2025-12-24T02:19:54.260715
finish_reason: stop
---

В предыдущем блоке кода мы начинаем с импорта необходимых зависимостей:

• Depends: Это вводит oauth2_scheme в функцию в качестве зависимости.

• OAuth2PasswordBearer: Этот класс сообщает приложению, что схема безопасности присутствует.

• verify_access_token: Эта функция, определенная в разделе создания и проверки токена доступа, будет использоваться для проверки действительности токена.

Затем мы определяем URL токена для схемы OAuth2 и функцию аутентификации. Функция аутентификации принимает токен в качестве аргумента. В функцию в качестве зависимости внедрена схема OAuth. Токен декодируется, и пользовательское поле полезной нагрузки возвращается, если токен действителен, в противном случае возвращаются адекватные ответы об ошибках, как определено в функции verify_access_token.

Теперь, когда мы успешно создали зависимость для защиты маршрутов, давайте обновим поток аутентификации в маршрутах, а также добавим функцию аутентификации в маршруты событий.

Обновление приложения

В этом разделе мы обновим маршруты для использования новой модели аутентификации. Наконец, мы обновим маршрут POST для добавления события, чтобы заполнить поле событий в записи пользователя.

Обновление маршрута входа пользователя

В routes/users.py обновите импорт:

```python
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordRequestForm
from auth.jwt_handler import create_access_token

from models.users import User
```

Мы импортировали класс OAuth2PasswordRequestForm из модуля безопасности FastAPI. Это будет введено в маршрут входа для получения отправленных учетных данных: имя пользователя и пароль. Давайте обновим функцию маршрута sign_user_in():

```python
async def sign_user_in(user: OAuth2PasswordRequestForm = Depends()) -> dict:
    user_exist = await User.find_one(User.email ==
---
source_image: page_164.png
page_number: 164
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 31.00
tokens: 7636
characters: 2550
timestamp: 2025-12-24T02:25:35.038395
finish_reason: stop
---

вычисляемых RNN векторов состояния. В главе 6 мы извлекали по вектору для каждого индекса пакета и выполняли предсказания на их основе. В данном примере мы сменим форму нашего тензора с трехмерного на двумерный (то есть матрицу), измерение строк в котором будет соответствовать выборкам (пакетам и индексам последовательности). С помощью этой матрицы и линейного слоя вычислим векторы предсказаний для каждой из выборок. В завершение вычислений мы снова преобразуем матрицу обратно в трехмерный тензор. Поскольку при операциях смены формы упорядоченность сохраняется, то пакеты и индексы последовательностей останутся на своих местах. Изменение формы необходимо потому, что слою Linear на входе требуется матрица.

Модель 2. Контекстно обусловленная модель SurnameGenerationModel

Наша вторая модель учитывает национальную принадлежность генерируемой фамилии. На деле это значит существование механизма для смещения поведения модели относительно конкретной фамилии. В этом примере мы параметризуем начальное скрытое состояние RNN, вкладывая каждую из национальностей в виде вектора размера скрытого состояния. Это значит, что при подстройке значений параметров модель также подстраивает значения в матрице вложений так, чтобы сделать предсказания более чувствительными к какой-либо конкретной национальности и закономерностям соответствующих фамилий. Например, вектор для ирландской национальности смещен в сторону последовательностей, начинающихся с Mc и O.

Пример 7.4 демонстрирует отличия контекстно обусловленной модели. А именно, в ней появляется дополнительный слой вложений для отображения индексов национальностей в векторы, размер которых совпадает со скрытым слоем RNN. Далее в функции forward выполняется вложение индексов национальностей, и они просто передаются в качестве начального скрытого слоя RNN. Хотя изменения, по сравнению с первой моделью, очень просты, они сильно влияют на возможность изменения поведения модели в зависимости от национальности, соответствующей генерируемой фамилии.

Пример 7.4. Контекстно обусловленная модель для генерации фамилий
class SurnameGenerationModel(nn.Module):
    def __init__(self, char_embedding_size, char_vocab_size,
                 num_nationalities, rnn_hidden_size, batch_first=True,
                 padding_idx=0, dropout_p=0.5):
        # ...
        self.nation_embedding = nn.Embedding(embedding_dim=rnn_hidden_size,
                                              num_embeddings=num_nationalities)

    def forward(self, x_in, nationality_index, apply_softmax=False):
        # ...
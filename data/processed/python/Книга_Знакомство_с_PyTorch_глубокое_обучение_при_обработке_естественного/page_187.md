---
source_image: page_187.png
page_number: 187
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 27.69
tokens: 7517
characters: 2177
timestamp: 2025-12-24T02:26:03.102079
finish_reason: stop
---

Рис. 8.11. Слева показана матрица дополненных нулями последовательностей и их длины. Дополненная матрица — стандартный вариант представления последовательностей переменной длины. Они дополняются справа нулями и располагаются ярусами, в виде строк. Во фреймворке PyTorch допустимо и более сжатое представление дополненных последовательностей, с помощью структуры данных PackedSequence, приведенной справа вместе с размерами пакетов. Благодаря этому представлению GPU может проходить последовательность, отслеживая количество последовательностей на каждом временному шаге (размеров пакетов)

Для создания PackedSequence необходимо знать длину всех последовательностей, кроме того, последовательности должны быть отсортированы в порядке убывания длины исходной последовательности. Для отражения этой вновь отсортированной матрицы оставшиеся в мини-пакете тензоры сортируются в том же порядке, чтобы соответствовать кодировке исходной последовательности. В примере 8.3 показаны изменения, внесенные в функцию generate_batches(), после которых она превратилась в generate_nmt_batches().

Пример 8.3. Генерация мини-пакетов для примера NMT

def generate_nmt_batches(dataset, batch_size, shuffle=True,
                         drop_last=True, device="cpu"):
    """ Функция-генератор — адаптер для объекта DataLoader
        фреймворка PyTorch; NMT-версия"""
    dataloader = DataLoader(dataset=dataset, batch_size=batch_size,
                            shuffle=shuffle, drop_last=drop_last)

    for data_dict in dataloader:
        lengths = data_dict['x_source_length'].numpy()
        sorted_length_indices = lengths.argsort()[::-1].tolist()

        out_data_dict = {}
        for name, tensor in data_dict.items():
            out_data_dict[name] = data_dict[name][sorted_length_indices].to(device)
        yield out_data_dict

Кодирование и декодирование в NMT-модели

В этом примере мы начинаем с исходной последовательности — предложения на английском языке — и генерируем целевую — соответствующий перевод на французский. Стандартный подход — использовать модели типа «кодировщик-декодировщик», как описано в первом разделе этой главы. В представленной в примерах 8.4 и 8.5
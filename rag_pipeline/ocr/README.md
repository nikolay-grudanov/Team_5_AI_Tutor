# OCR –ú–æ–¥—É–ª—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ (OCR) —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—á–µ–±–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ vLLM —Å–µ—Ä–≤–µ—Ä —Å –º–æ–¥–µ–ª—å—é olmOCR.

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (PNG, JPG, JPEG)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª (LaTeX)
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (ThreadPoolExecutor)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Markdown —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ Resume: –ø—Ä–æ–ø—É—Å–∫ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (tqdm)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```
pip install requests Pillow tqdm python-dotenv
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```
# =============================================================================
# vLLM –°–ï–†–í–ï–†
# =============================================================================
VLLM_BASE_URL=https://your-vllm-server.cloud.ru/v1
VLLM_MODEL_NAME=model-run-olm-ocr
VLLM_API_KEY=EMPTY

# =============================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–†–ê–ë–û–¢–ö–ò
# =============================================================================
MAX_WORKERS=4                # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤

# =============================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô
# =============================================================================
RESIZE_IMAGE=false           # –ò–∑–º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
MAX_IMAGE_SIZE=1920          # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–µ—Å–ª–∏ resize=true)

# =============================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ –ì–ï–ù–ï–†–ê–¶–ò–ò
# =============================================================================
TIMEOUT=300                  # –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (—Å–µ–∫—É–Ω–¥—ã)
TEMPERATURE=0.0              # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
MAX_TOKENS=8192              # –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤
PROMPT_TYPE=olmocr_technical # –¢–∏–ø –ø—Ä–æ–º–ø—Ç–∞

# =============================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ YAML (–¥–ª—è olmOCR –ø—Ä–æ–º–ø—Ç–æ–≤)
# =============================================================================
YAML_LANGUAGE=ru             # –Ø–∑—ã–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (ru, en, mixed)
YAML_IS_TABLE=true           # –ï—Å—Ç—å –ª–∏ —Ç–∞–±–ª–∏—Ü—ã
YAML_IS_DIAGRAM=true         # –ï—Å—Ç—å –ª–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã/–≥—Ä–∞—Ñ–∏–∫–∏

# =============================================================================
# –ü–£–¢–ò –ö –î–ê–ù–ù–´–ú
# =============================================================================
DATA_RAW_DIR=data/raw
DATA_PROCESSED_DIR=data/processed

# =============================================================================
# –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# =============================================================================
LOG_LEVEL=INFO
LOG_FILE=logs/ocr_processing.log
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```
python -m rag_pipeline.ocr.client
```

**–í—ã–≤–æ–¥:**
```
‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: VLLMClient(base_url='https://...')
‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

```
python -m rag_pipeline.ocr.processor data/raw/math/–ö–Ω–∏–≥–∞/page_001.png
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–ø–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```
# –û–¥–Ω–∞ –∫–Ω–∏–≥–∞
python scripts/run_ocr.py --input data/raw/math/–ö–Ω–∏–≥–∞_1 --workers 4

# –í—Å–µ –∫–Ω–∏–≥–∏ –≤ math/
python scripts/run_ocr.py --input data/raw/math --recursive --workers 4
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: Python API

```
from rag_pipeline.ocr import OCRPipeline

# –°–æ–∑–¥–∞–Ω–∏–µ pipeline
pipeline = OCRPipeline()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–ø–∫–∏
results = pipeline.process_directory(
    input_dir="data/raw/math/–ö–Ω–∏–≥–∞",
    max_workers=4,
    resume=True  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
)

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
pipeline.print_summary()
```

## üìä –§–æ—Ä–º–∞—Ç –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

–ö–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `.md` —Ñ–∞–π–ª —Å YAML frontmatter:

```
***
source_image: page_001.png
page_number: 1
model: model-run-olm-ocr
prompt_type: olmocr_technical
processing_time: 13.45
tokens: 4020
characters: 3411
timestamp: 2025-12-23T22:15:30.123456
finish_reason: stop
***

[–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å LaTeX —Ñ–æ—Ä–º—É–ª–∞–º–∏]
```

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫

```
data/
‚îú‚îÄ‚îÄ raw/                          # –ò—Å—Ö–æ–¥–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ math/
‚îÇ       ‚îú‚îÄ‚îÄ –ö–Ω–∏–≥–∞_1/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ page_001.png
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ page_002.png
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îî‚îÄ‚îÄ –ö–Ω–∏–≥–∞_2/
‚îÇ           ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ processed/                    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã OCR
    ‚îî‚îÄ‚îÄ math/
        ‚îú‚îÄ‚îÄ –ö–Ω–∏–≥–∞_1/
        ‚îÇ   ‚îú‚îÄ‚îÄ page_001.md
        ‚îÇ   ‚îú‚îÄ‚îÄ page_002.md
        ‚îÇ   ‚îî‚îÄ‚îÄ ...
        ‚îî‚îÄ‚îÄ –ö–Ω–∏–≥–∞_2/
            ‚îî‚îÄ‚îÄ ...
```

## üéõÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

```
python scripts/run_ocr.py \
  --input data/raw/math/–ö–Ω–∏–≥–∞ \   # –ü–∞–ø–∫–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
  --workers 8 \                   # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤
  --no-resume \                   # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å—ë –∑–∞–Ω–æ–≤–æ
  --recursive                     # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –ø–æ–¥–ø–∞–ø–∫–∏
```

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ü–æ—Ç–æ–∫–∏ | –°–∫–æ—Ä–æ—Å—Ç—å | –í—Ä–µ–º—è –Ω–∞ 11,341 —Å—Ç—Ä |
|--------|----------|---------------------|
| 1      | ~13 —Å–µ–∫/—Å—Ç—Ä | ~41 —á–∞—Å |
| 4      | ~3.25 —Å–µ–∫/—Å—Ç—Ä | ~10 —á–∞—Å–æ–≤ |
| 8      | ~1.63 —Å–µ–∫/—Å—Ç—Ä | ~5 —á–∞—Å–æ–≤ |

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** 4-8 –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.

## üîç Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "vLLM —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `VLLM_BASE_URL` –≤ `.env`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```
# –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
curl https://your-vllm-server.cloud.ru/v1/models
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á—å—Ç–µ `MAX_WORKERS=8`
2. –í–∫–ª—é—á–∏—Ç–µ `RESIZE_IMAGE=true`
3. –£–º–µ–Ω—å—à–∏—Ç–µ `MAX_IMAGE_SIZE=1280`

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á—å—Ç–µ `TIMEOUT=600`
2. –£–º–µ–Ω—å—à–∏—Ç–µ `MAX_WORKERS=2`

### –ü—Ä–æ–±–ª–µ–º–∞: RuntimeWarning –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ—Ç `python -m`, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É.

## üìö –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
rag_pipeline/ocr/
‚îú‚îÄ‚îÄ __init__.py       # –≠–∫—Å–ø–æ—Ä—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ API
‚îú‚îÄ‚îÄ config.py         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ .env
‚îú‚îÄ‚îÄ utils.py          # –£—Ç–∏–ª–∏—Ç—ã (base64, –ø—É—Ç–∏, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
‚îú‚îÄ‚îÄ client.py         # vLLM API –∫–ª–∏–µ–Ω—Ç
‚îú‚îÄ‚îÄ processor.py      # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ pipeline.py       # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–ø–∫–∏
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
python -m rag_pipeline.ocr.config

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
python -m rag_pipeline.ocr.client

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–∏–ª–∏—Ç
python -m rag_pipeline.ocr.utils

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
python -m rag_pipeline.ocr.processor data/raw/math/–ö–Ω–∏–≥–∞/page_001.png

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–ø–∫–∏
python -m rag_pipeline.ocr.pipeline data/raw/math/–ö–Ω–∏–≥–∞
```

## üìñ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–π –∫–Ω–∏–≥–∏

```
from rag_pipeline.ocr import OCRPipeline

pipeline = OCRPipeline()
results = pipeline.process_directory("data/raw/math/–ö–Ω–∏–≥–∞_1")
```

### –ü—Ä–∏–º–µ—Ä 2: –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```
from rag_pipeline.ocr import OCRConfig, OCRPipeline

# –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
config = OCRConfig()
config.max_workers = 8
config.temperature = 0.1
config.timeout = 600

# Pipeline —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
pipeline = OCRPipeline(config=config)
results = pipeline.process_directory("data/raw/math/–ö–Ω–∏–≥–∞_1")
```

### –ü—Ä–∏–º–µ—Ä 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å retry

```
from rag_pipeline.ocr import OCRPipeline

pipeline = OCRPipeline()

# –ü–µ—Ä–≤—ã–π –ø—Ä–æ—Ö–æ–¥
results = pipeline.process_directory("data/raw/math/–ö–Ω–∏–≥–∞_1", resume=True)

# –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫
failed_files = [r['image_path'] for r in results if not r['success']]

if failed_files:
    print(f"–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ {len(failed_files)} –æ—à–∏–±–æ–∫...")
    for img_path in failed_files:
        result = pipeline.processor.process_image(img_path)
        if result['success']:
            print(f"‚úì {img_path.name}")
```

## üîß –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–æ–º–ø—Ç–∞

–í `client.py`:

```
def _get_prompt(self, prompt_type: str) -> str:
    prompts = {
        "custom_prompt": "–í–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∑–¥–µ—Å—å",
        # ... –¥—Ä—É–≥–∏–µ –ø—Ä–æ–º–ø—Ç—ã
    }
    return prompts.get(prompt_type, prompts["olmocr_technical"])
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```
PROMPT_TYPE=custom_prompt python scripts/run_ocr.py --input data/raw/math/–ö–Ω–∏–≥–∞
```